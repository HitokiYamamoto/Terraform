name: Check Go Files

on:
  pull_request:
    branches:
      - "**"

env:
  WORKING_DIRECTORY: google-cloud/notification/src

jobs:
  # 変更検知ジョブ
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      golang: ${{ steps.filter.outputs.golang }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check for changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            golang:
              - 'google-cloud/notification/src/**'

  lint:
    needs: changes
    if: ${{ needs.changes.outputs.golang == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Go and Task
        uses: ./.github/actions/setup-go-task
        with:
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Run Lint Task
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: task lint-check

  test:
    needs:
      - changes
    if: ${{ needs.changes.outputs.golang == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Go and Task
        uses: ./.github/actions/setup-go-task
        with:
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Run Test Task
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: task test

  format-check:
    needs: changes
    if: ${{ needs.changes.outputs.golang == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Go and Task
        uses: ./.github/actions/setup-go-task
        with:
          working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Run Format Check Task
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: task format-check

  # 統合チェックジョブ - Branch Protectionではこのジョブを必須にする
  check-golang-result:
    runs-on: ubuntu-latest
    needs: [changes, lint, test, format-check]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          # 変更がない場合はスキップ扱いで成功
          if [ "${{ needs.changes.outputs.golang }}" != "true" ]; then
            echo "✅ No changes in Go files - skipping checks"
            exit 0
          fi

          # 変更がある場合は全ジョブが成功しているか確認
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Lint job failed or was cancelled"
            exit 1
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Test job failed or was cancelled"
            exit 1
          fi

          if [ "${{ needs.format-check.result }}" != "success" ]; then
            echo "❌ Format check job failed or was cancelled"
            exit 1
          fi

          echo "✅ All Go checks passed successfully!"
