name: Check Docker Build

on:
  pull_request:
    branches:
      - "**"

jobs:
  # 変更検知ジョブ
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      dockerfile_terraform: ${{ steps.filter.outputs.dockerfile_terraform }}
      dockerfile_firestore: ${{ steps.filter.outputs.dockerfile_firestore }}
      dockerfile_golang: ${{ steps.filter.outputs.dockerfile_golang }}
      dockerfile_node: ${{ steps.filter.outputs.dockerfile_node }}
      dockerfile_python: ${{ steps.filter.outputs.dockerfile_python }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check for changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            dockerfile_terraform:
              - 'docker/build/Dockerfile.terraform'
            dockerfile_firestore:
              - 'docker/build/Dockerfile.firestore'
            dockerfile_golang:
              - 'docker/build/Dockerfile.golang'
            dockerfile_node:
              - 'docker/build/Dockerfile.node'
            dockerfile_python:
              - 'docker/build/Dockerfile.python'

  # Dockerfile.terraform のビルドチェック
  build-dockerfile-terraform:
    needs: changes
    if: ${{ needs.changes.outputs.dockerfile_terraform == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: docker/build
          file: docker/build/Dockerfile.terraform
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Dockerfile.firestore のビルドチェック
  build-dockerfile-firestore:
    needs: changes
    if: ${{ needs.changes.outputs.dockerfile_firestore == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: docker/build
          file: docker/build/Dockerfile.firestore
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Dockerfile.golang のビルドチェック
  build-dockerfile-golang:
    needs: changes
    if: ${{ needs.changes.outputs.dockerfile_golang == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: docker/build
          file: docker/build/Dockerfile.golang
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Dockerfile.node のビルドチェック
  build-dockerfile-node:
    needs: changes
    if: ${{ needs.changes.outputs.dockerfile_node == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: docker/build
          file: docker/build/Dockerfile.node
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Dockerfile.python のビルドチェック
  build-dockerfile-python:
    needs: changes
    if: ${{ needs.changes.outputs.dockerfile_python == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: docker/build
          file: docker/build/Dockerfile.python
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 統合チェックジョブ - Branch Protectionではこのジョブを必須にする
  docker-build-result:
    runs-on: ubuntu-latest
    needs:
      - changes
      - build-dockerfile-terraform
      - build-dockerfile-firestore
      - build-dockerfile-golang
      - build-dockerfile-node
      - build-dockerfile-python
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          # 変更がない場合はスキップ扱いで成功
          if [ "${{ needs.changes.outputs.dockerfile_terraform }}" != "true" ] && \
             [ "${{ needs.changes.outputs.dockerfile_firestore }}" != "true" ] && \
             [ "${{ needs.changes.outputs.dockerfile_golang }}" != "true" ] && \
             [ "${{ needs.changes.outputs.dockerfile_node }}" != "true" ] && \
             [ "${{ needs.changes.outputs.dockerfile_python }}" != "true" ]; then
            echo "✅ No changes in Docker build files - skipping checks"
            exit 0
          fi

          # 変更がある場合は該当ジョブが成功しているか確認
          HAS_FAILURE=false

          if [ "${{ needs.changes.outputs.dockerfile_terraform }}" == "true" ] && [ "${{ needs.build-dockerfile-terraform.result }}" != "success" ]; then
            echo "❌ Dockerfile build job failed or was cancelled"
            HAS_FAILURE=true
          fi

          if [ "${{ needs.changes.outputs.dockerfile_firestore }}" == "true" ] && [ "${{ needs.build-dockerfile-firestore.result }}" != "success" ]; then
            echo "❌ Dockerfile.firestore build job failed or was cancelled"
            HAS_FAILURE=true
          fi

          if [ "${{ needs.changes.outputs.dockerfile_golang }}" == "true" ] && [ "${{ needs.build-dockerfile-golang.result }}" != "success" ]; then
            echo "❌ Dockerfile.golang build job failed or was cancelled"
            HAS_FAILURE=true
          fi

          if [ "${{ needs.changes.outputs.dockerfile_node }}" == "true" ] && [ "${{ needs.build-dockerfile-node.result }}" != "success" ]; then
            echo "❌ Dockerfile.node build job failed or was cancelled"
            HAS_FAILURE=true
          fi

          if [ "${{ needs.changes.outputs.dockerfile_python }}" == "true" ] && [ "${{ needs.build-dockerfile-python.result }}" != "success" ]; then
            echo "❌ Dockerfile.python build job failed or was cancelled"
            HAS_FAILURE=true
          fi

          if [ "$HAS_FAILURE" == "true" ]; then
            exit 1
          fi

          echo "✅ All Docker build checks passed successfully!"
