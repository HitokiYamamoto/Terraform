name: Terraform

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  yamllint:
    name: Yaml Check
    runs-on: ubuntu-latest
    env:
      YAMLLINT_VERSION: "v1.38.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7
        with:
          python-version: "3.14.2"
          version: "0.9.29"
          enable-cache: false # uv tool runで毎回ツールをインストールするためキャッシュ無効化

      - name: Run yamllint
        run: uv tool run yamllint@${{ env.YAMLLINT_VERSION }} .

  prettier:
    name: Prettier Check
    runs-on: ubuntu-latest
    env:
      PRETTIER_VERSION: 3.8.1
      NODE_VERSION: 24.13.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Prettier
        run: npx prettier@${{ env.PRETTIER_VERSION }} --config config/.prettierrc --check .

  terraform-format-check:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      - name: Format Terraform code
        run: terraform fmt -check -recursive -diff

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6
        with:
          tflint_version: v0.60.0

      - name: Run tflint
        run: |
          tflint --init
          tflint --recursive

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    env:
      TRIVY_VERSION: v0.69.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          version: ${{ env.TRIVY_VERSION }}
          scan-type: fs
          scan-ref: "."
          format: table
          exit-code: "1"
          severity: CRITICAL,HIGH,MEDIUM,LOW
          scanners: misconfig,secret,vuln
          trivyignores: .trivyignore
          skip-files: "google-cloud/bootstrap/main.tf" # GCP-0078が誤検知するためスキップ

  terraform:
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write
    uses: ./.github/workflows/terraform.yaml
    secrets: inherit

  # 統合チェックジョブ - Branch Protectionではこのジョブを必須にする
  ci-result:
    runs-on: ubuntu-latest
    needs:
      - yamllint
      - prettier
      - terraform-format-check
      - terraform-lint
      - security-scan
      - terraform
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          # 全ジョブが成功しているか確認
          # terraform は workflow_call なので、内部の terraform-result を見る
          if [ "${{ needs.yamllint.result }}" != "success" ]; then
            echo "❌ YAML lint job failed or was cancelled"
            exit 1
          fi

          if [ "${{ needs.prettier.result }}" != "success" ]; then
            echo "❌ Prettier job failed or was cancelled"
            exit 1
          fi

          if [ "${{ needs.terraform-format-check.result }}" != "success" ]; then
            echo "❌ Terraform format check job failed or was cancelled"
            exit 1
          fi

          if [ "${{ needs.terraform-lint.result }}" != "success" ]; then
            echo "❌ Terraform lint job failed or was cancelled"
            exit 1
          fi

          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ Security scan job failed or was cancelled"
            exit 1
          fi

          # terraform workflow 全体の結果をチェック
          # workflow_call の場合、内部の terraform-result が最終判定するので
          # ワークフロー全体が success であればOK
          if [ "${{ needs.terraform.result }}" != "success" ]; then
            echo "❌ Terraform workflow failed or was cancelled"
            exit 1
          fi

          echo "✅ All CI checks passed successfully!"
