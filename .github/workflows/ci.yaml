name: Terraform

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  yamllint:
    name: Yaml Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint

  prettier:
    name: Prettier Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Run Prettier
        run: npx prettier --check .

  format-check:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      - name: Format Terraform code
        run: terraform fmt -check -recursive -diff

  lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: v0.55.0

      - name: Run tflint
        run: |
          tflint --init
          tflint --recursive

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Trivy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: "."
          format: table
          exit-code: "1"
          severity: CRITICAL,HIGH,MEDIUM,LOW
          scanners: config,secret,vuln

  terraform:
    permissions:
      contents: read
      id-token: write
    needs:
      - yamllint
      - prettier
      - format-check
      - lint
      - security-scan
    uses: ./.github/workflows/terraform.yaml
    secrets: inherit
